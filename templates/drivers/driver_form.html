{% extends 'base/base.html' %}

{% block title %}{% if form.instance.pk %}Edit Driver{% else %}Add Driver{% endif %} - FleetFlow{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit Driver{% else %}Add Driver{% endif %}{% endblock %}


{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold">
                    <i class="bi bi-person-plus me-2"></i>
                    {% if form.instance.pk %}Edit Driver: {{ form.instance.full_name }}{% else %}Add New Driver{% endif %}
                </h6>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="driverForm">
                    {% csrf_token %}
                    
                    <!-- Profile Picture Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex align-items-center">
                                <div class="me-4">
                                    {% if form.instance.profile_picture %}
                                        <img src="{{ form.instance.profile_picture.url }}" alt="{{ form.instance.full_name }}" 
                                             class="rounded-circle border" width="100" height="100" id="profilePreview">
                                    {% else %}
                                        <div class="rounded-circle bg-light border d-flex align-items-center justify-content-center" 
                                             style="width: 100px; height: 100px;" id="profilePreview">
                                            <i class="bi bi-person text-muted" style="font-size: 2.5rem;"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <label for="{{ form.profile_picture.id_for_label }}" class="form-label">
                                        <i class="bi bi-camera me-1"></i>Profile Picture
                                    </label>
                                    <input type="file" class="form-control" id="{{ form.profile_picture.id_for_label }}" 
                                           name="{{ form.profile_picture.html_name }}" accept="image/*" onchange="previewImage(event)">
                                    <small class="text-muted">Allowed: JPG, PNG, GIF (Max 5MB)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-badge me-2"></i>Personal Information
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                    <i class="bi bi-person me-1"></i>First Name <span class="text-danger">*</span>
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.first_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                    <i class="bi bi-person me-1"></i>Last Name <span class="text-danger">*</span>
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.last_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    <i class="bi bi-envelope me-1"></i>Email Address <span class="text-danger">*</span>
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.email.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">
                                    <i class="bi bi-telephone me-1"></i>Phone Number <span class="text-danger">*</span>
                                </label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.phone.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>Address
                                </label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.address.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-event me-1"></i>Date of Birth <span class="text-danger">*</span>
                                </label>
                                {{ form.date_of_birth }}
                                {% if form.date_of_birth.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.date_of_birth.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.hire_date.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-check me-1"></i>Hire Date <span class="text-danger">*</span>
                                </label>
                                {{ form.hire_date }}
                                {% if form.hire_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.hire_date.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- License Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-success mb-3">
                                <i class="bi bi-card-text me-2"></i>License Information
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.license_number.id_for_label }}" class="form-label">
                                    <i class="bi bi-badge me-1"></i>License Number <span class="text-danger">*</span>
                                </label>
                                {{ form.license_number }}
                                {% if form.license_number.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.license_number.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.license_type.id_for_label }}" class="form-label">
                                    <i class="bi bi-credit-card me-1"></i>License Type <span class="text-danger">*</span>
                                </label>
                                {{ form.license_type }}
                                {% if form.license_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.license_type.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.license_expiry.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-x me-1"></i>License Expiry Date <span class="text-danger">*</span>
                                </label>
                                {{ form.license_expiry }}
                                {% if form.license_expiry.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.license_expiry.errors.0 }}
                                    </div>
                                {% endif %}
                                {% if form.instance.license_expiry %}
                                    <div class="form-text mt-1">
                                        {% if form.instance.license_expired %}
                                            <span class="badge bg-danger">EXPIRED</span>
                                        {% elif form.instance.license_expires_soon %}
                                            {% load tz %}
                                            {% now "Y-m-d" as today %}
                                            {% with days=form.instance.license_expiry|timeuntil:today %}
                                                {% if days.days > 0 %}
                                                    <span class="badge bg-warning">EXPIRES IN {{ days.days }} DAYS</span>
                                                {% else %}
                                                    <span class="badge bg-success">EXPIRED</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            <span class="badge bg-success">VALID</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    <i class="bi bi-toggle-on me-1"></i>Status <span class="text-danger">*</span>
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.status.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Contact Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-warning mb-3">
                                <i class="bi bi-telephone-fill me-2"></i>Emergency Contact
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.emergency_contact.id_for_label }}" class="form-label">
                                    <i class="bi bi-person-lines-fill me-1"></i>Emergency Contact Name
                                </label>
                                {{ form.emergency_contact }}
                                {% if form.emergency_contact.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.emergency_contact.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.emergency_phone.id_for_label }}" class="form-label">
                                    <i class="bi bi-telephone-fill me-1"></i>Emergency Phone Number
                                </label>
                                {{ form.emergency_phone }}
                                {% if form.emergency_phone.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.emergency_phone.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Financial Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-info mb-3">
                                <i class="bi bi-currency-dollar me-2"></i>Financial Information
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.salary.id_for_label }}" class="form-label">
                                    <i class="bi bi-cash me-1"></i>Annual Salary ($)
                                </label>
                                {{ form.salary }}
                                {% if form.salary.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.salary.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-label">
                                    <i class="bi bi-info-circle me-1"></i>Required Fields <span class="text-danger">*</span>
                                </div>
                                <small class="text-muted">All fields marked with asterisk are required</small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="submit" class="btn btn-primary btn-lg px-4">
                                    <i class="bi bi-check-circle me-2"></i>
                                    {% if form.instance.pk %}Update Driver{% else %}Add Driver{% endif %}
                                </button>
                                <a href="{% url 'drivers:driver_list' %}" class="btn btn-outline-secondary btn-lg px-4">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.form-control {
    border: 2px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background-color: #ffffff;
}

.form-control:focus {
    border-color: #0066cc;
    box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.25);
    background-color: #f8f9ff;
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.invalid-feedback {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    background-color: #f8d7da;
    padding: 0.5rem;
    border-radius: 0.375rem;
    border-left: 4px solid #dc3545;
}

.form-text {
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.border {
    border: 3px solid #e9ecef;
    padding: 0.25rem;
    border-radius: 0.5rem;
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.btn-lg:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.text-danger {
    color: #dc3545 !important;
}

.gap-2 {
    gap: 0.5rem;
}

/* Profile picture preview styles */
#profilePreview {
    transition: all 0.3s ease;
    cursor: pointer;
}

#profilePreview:hover {
    border-color: #0066cc;
    transform: scale(1.05);
}

/* Section headers */
.text-primary, .text-success, .text-warning, .text-info {
    border-bottom: 2px solid;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.text-primary {
    color: #0066cc !important;
    border-color: #0066cc;
}

.text-success {
    color: #28a745 !important;
    border-color: #28a745;
}

.text-warning {
    color: #ffc107 !important;
    border-color: #ffc107;
}

.text-info {
    color: #17a2b8 !important;
    border-color: #17a2b8;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .d-flex.justify-content-end {
        flex-direction: column;
        gap: 1rem !important;
    }
    
    .btn-lg {
        width: 100%;
    }
}
</style>

<script>
function previewImage(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profilePreview');
            if (preview.tagName === 'IMG') {
                preview.src = e.target.result;
            } else {
                preview.innerHTML = `<img src="${e.target.result}" class="rounded-circle border" width="100" height="100">`;
            }
        };
        reader.readAsDataURL(file);
    }
}

// Form validation enhancement
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('driverForm');
    const inputs = form.querySelectorAll('.form-control');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value.trim() !== '') {
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
            }
        });
    });
});
</script>
{% endblock %}
